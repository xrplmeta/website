import { formatValue } from '@xrplkit/amount'
import Pager from './Pager.xjs'
import Search from './Search.xjs'

include '~/styles/tokens.xcss'



export default {
	oncreate: async x => {
		x.tokens.events.on('update', x.redraw)
		await x.tokens.load()
	},
	onremove: x => {
		x.tokens.events.off('update', x.redraw)
	},
	view: x => (
		<stack class="tokens">
			<Search
				input={x.tokens.nameFilter}
				oninput={input => x.tokens.setNameFilter(input)}
			/>
			<flex class="head">
				<stack>
					Token
				</stack>
				<stack>
					7 Day Trading Volume
				</stack>
				<stack>
					Trustlines
				</stack>
			</flex>
			{#if x.tokens.list}
				<stack class={`list ${x.tokens.loading ? `loading` : ``}`}>
					{#for let token of x.tokens.list}
						<Entry token={token} key={`${token.currency}:${token.issuer}`}/>
					{/for}
				</stack>
				{#if x.tokens.pages > 1}
					<Pager
						page={x.tokens.page}
						pages={x.tokens.pages}
						onpage={page => x.tokens.setPage(page) & window.scrollTo(0, 100)}
					/>
				{/if}
			{:else}
				<stack class="list placeholder">
					<EntryPlaceholder/>
					<EntryPlaceholder/>
					<EntryPlaceholder/>
					<EntryPlaceholder/>
					<EntryPlaceholder/>
					<EntryPlaceholder/>
					<EntryPlaceholder/>
					<EntryPlaceholder/>
				</stack>
			{/if}
		</stack>
	)
}

const Entry = x => {
	let token = x.attrs.token
	let meta = token.meta
	let metrics = token.metrics
	let icon = meta.token.icon || meta.issuer.icon
	let formattedVolume = formatValue(metrics.volume_7d)
	let formattedTrustlines = metrics.trustlines.toLocaleString('en')

	return x => (
		<flex class="entry">
			<link to={`/tokens/${token.currency}:${token.issuer}`}>
				{#if icon}
					<icon class="icon" src={icon}/>
				{:else}
					<icon class="icon placeholder" asset="token-placeholder"/>
				{/if}
			</link>
			<stack class="name">
				<link to={`/tokens/${token.currency}:${token.issuer}`}>
					<label>{token.currency}</label>
					<label>{token.issuer}</label>
				</link>
			</stack>
			<stack class="volume">
				{formattedVolume} XRP
			</stack>
			<stack class="trustlines">
				{formattedTrustlines}
			</stack>
		</flex>
	)
}


const EntryPlaceholder = x => (
	<flex class="entry placeholder">
		<stack class="icon"/>
		<stack class="name">
			<label/>
		</stack>
		<stack class="volume">
			<label/>
		</stack>
		<stack class="trustlines">
			<label/>
		</stack>
	</flex>
)